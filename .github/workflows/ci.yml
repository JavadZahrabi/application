name: CI

on:
  push:
    branches: [ "master" ]
    paths-ignore:
      - '.github/workflows/**'
  pull_request:
    branches: [ "master" ]

env:
  DOCKER_USER: ${{secrets.DOCKER_USER}}
  DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
  DOCKER_REPO_NAME: ${{secrets.DOCKER_REPO_NAME}}

jobs:

  build:
    runs-on: ubuntu-latest
    
    outputs:
      date: ${{ steps.tagInfo.outputs.date }}
      shaShort: ${{ steps.tagInfo.outputs.shaShort }}    
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Get tag info
        id: tagInfo
        run: |
          echo "::set-output name=date::$(date +'%Y-%m-%d')"
          echo "::set-output name=shaShort::$(git rev-parse --short HEAD)"    
      
      - name: Build the Docker image
        run: docker build -t $DOCKER_USER/$DOCKER_REPO_NAME .

      - name: Login to Docker Hub
        run: |
            docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
      - name: Push image to dockerhub
        run: |
          docker tag $DOCKER_USER/$DOCKER_REPO_NAME:latest $DOCKER_USER/$DOCKER_REPO_NAME:${{ steps.tagInfo.outputs.date }}-${{ steps.tagInfo.outputs.shaShort }}
          echo "Push image $DOCKER_USER/$DOCKER_REPO_NAME:${{ steps.tagInfo.outputs.date }}-${{ steps.tagInfo.outputs.shaShort }}"
          docker push $DOCKER_USER/$DOCKER_REPO_NAME:${{ steps.tagInfo.outputs.date }}-${{ steps.tagInfo.outputs.shaShort }}

  copy settings and update tag for dev staging prod:
    needs: build
    runs-on: ubuntu-latest
     
    steps:

      - name: Checkout gitops-environment-promotion-source-code_02
        uses: actions/checkout@v3
        with:
          path: ./gitops-environment-promotion-source-code_02

      - name: Checkout gitops-environment-promotion_02
        uses: actions/checkout@v3
        with:
          repository: JavadZahrabi/gitops-environment-promotion_02
          token: ${{ secrets.ACTIONS_TOKEN }}
          path: ./gitops-environment-promotion_02
      
      - name: Copy & push dev_settings
        run: |
            FILE1=./gitops-environment-promotion-source-code_02/environment-variables/dev/dev_settings.yml
            FILE2=./gitops-environment-promotion_02/envs/dev/dev_settings.yml
            if cmp -s "$FILE1" "$FILE2"; then
              echo "dev_settings are same"
            else
              echo "dev_settings are different"
              cp -R ./gitops-environment-promotion-source-code_02/environment-variables/dev/dev_settings.yml ./gitops-environment-promotion_02/envs/dev
              cd ./gitops-environment-promotion_02
              git add .
              git config user.name ci
              git config user.email ci@github.com
              git commit -am "dev_setting.yml replicated from gitops-environment-promotion-source-code_02"
              git push
            fi

      - name: update dev image tag
        run: |
            export tag=${{needs.build.outputs.date}}-${{needs.build.outputs.shaShort}}

            echo update Docker Image tag on dev
            cd ./gitops-environment-promotion_02/envs/dev
            kustomize edit set image docker.io/javadza/environment-promotion=docker.io/javadza/environment-promotion:${tag}

            echo push new tag to dev
            git add .
            git config user.name ci
            git config user.email ci@github.com
            git commit -am "update dev image tag in environment repository"
            git push

      - name: Copy & push staging_settings
        run: |
            FILE1=./gitops-environment-promotion-source-code_02/environment-variables/staging/staging_settings.yml
            FILE2=./gitops-environment-promotion_02/envs/staging/staging_settings.yml
            if cmp -s "$FILE1" "$FILE2"; then
              echo "staging_settings are same"
            else
              echo "staging_settings are different"
              cp -R ./gitops-environment-promotion-source-code_02/environment-variables/staging/staging_settings.yml ./gitops-environment-promotion_02/envs/staging
            fi

            export tag=${{needs.build.outputs.date}}-${{needs.build.outputs.shaShort}}

            echo update Docker Image tag on staging
            cd ./gitops-environment-promotion_02/envs/staging
            kustomize edit set image docker.io/javadza/environment-promotion=docker.io/javadza/environment-promotion:${tag}

      - name: create pull request staging
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.ACTIONS_TOKEN }}
          commit-message: update setting and tag of staging

            


